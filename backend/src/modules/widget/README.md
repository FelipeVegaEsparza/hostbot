# Widget Module

This module provides endpoints for the embeddable widget to interact with the chatbot system.

## Overview

The Widget module handles:
- Receiving messages from the widget embedded in customer websites
- Automatically creating conversations if they don't exist
- Enqueuing messages for asynchronous AI processing
- Providing widget configuration (theme, colors, welcome message)

## Endpoints

### POST /widget/message

Receives a message from the widget and enqueues it for processing.

**Request Body:**
```json
{
  "botId": "123e4567-e89b-12d3-a456-426614174000",
  "message": "Hello, I need help",
  "externalUserId": "widget-user-abc123",
  "conversationId": "optional-conversation-id",
  "metadata": {
    "userAgent": "Mozilla/5.0...",
    "pageUrl": "https://example.com/page"
  }
}
```

**Response (202 Accepted):**
```json
{
  "conversationId": "123e4567-e89b-12d3-a456-426614174000",
  "messageId": "123e4567-e89b-12d3-a456-426614174001",
  "status": "accepted"
}
```

**Features:**
- Returns 202 Accepted for asynchronous processing
- Automatically creates conversation if it doesn't exist
- Validates chatbot exists and is active
- Enqueues message in `incoming-messages` queue for AI processing

### GET /widget/config/:botId

Returns the public configuration for the widget.

**Response (200 OK):**
```json
{
  "botId": "123e4567-e89b-12d3-a456-426614174000",
  "botName": "Customer Support Bot",
  "widgetSettings": {
    "theme": "light",
    "primaryColor": "#3B82F6",
    "position": "bottom-right",
    "welcomeMessage": "Hello! How can I help you today?",
    "placeholder": "Type a message...",
    "customCss": null
  }
}
```

**Features:**
- Returns default settings if widget settings are not configured
- Validates chatbot exists and is active
- Public endpoint (no authentication required)

## Architecture

### Message Flow

```
Widget → POST /widget/message → WidgetService → MessagesService → Queue
                                                                      ↓
                                                            incoming-messages
                                                                      ↓
                                                            AI Processing
                                                                      ↓
                                                            Response sent back
```

### Conversation Creation

The widget automatically creates conversations using the following logic:
1. Check if `conversationId` is provided in the request
2. If yes, use existing conversation
3. If no, find or create conversation based on:
   - `chatbotId`
   - `externalUserId` (generated by widget, stored in localStorage)
   - `channel` (always 'WIDGET')

### External User ID

The widget generates a unique `externalUserId` for each visitor and stores it in localStorage. This allows:
- Conversation continuity across page reloads
- Multiple conversations per chatbot
- User identification without authentication

## Dependencies

- **PrismaModule**: Database access
- **MessagesModule**: Message creation and queueing

## Security Considerations

1. **No Authentication Required**: Widget endpoints are public to allow embedding
2. **Chatbot Validation**: Verifies chatbot exists and is active
3. **Rate Limiting**: Should be applied at the API gateway level
4. **CORS**: Must be configured to allow cross-origin requests from customer websites

## Usage Example

### Widget Integration

```html
<!-- Customer website -->
<script src="https://cdn.example.com/widget.js"></script>
<chatbot-widget 
  bot-id="123e4567-e89b-12d3-a456-426614174000"
  api-url="https://api.example.com">
</chatbot-widget>
```

### Widget JavaScript

```javascript
// Widget sends message
const response = await fetch('https://api.example.com/widget/message', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    botId: 'bot-id',
    message: 'Hello',
    externalUserId: localStorage.getItem('widgetUserId'),
    conversationId: localStorage.getItem('conversationId'),
    metadata: {
      userAgent: navigator.userAgent,
      pageUrl: window.location.href
    }
  })
});

const data = await response.json();
// Store conversationId for future messages
localStorage.setItem('conversationId', data.conversationId);
```

## Testing

### Unit Tests

Test the service methods:
- `sendMessage()` - Message creation and queueing
- `getConfig()` - Configuration retrieval

### Integration Tests

Test the endpoints:
- POST /widget/message with valid data
- POST /widget/message with invalid botId
- POST /widget/message with inactive chatbot
- GET /widget/config/:botId with valid botId
- GET /widget/config/:botId with invalid botId

## Requirements Covered

This module implements the following requirements:

- **3.1**: Widget establishes connection with API Backend
- **3.2**: Widget transmits messages to API Backend with chatbot identifier
- **3.3**: Automatic conversation creation if it doesn't exist
- **3.4**: Message enqueuing in incoming-messages queue
- **15.7**: Widget endpoints implementation

## Future Enhancements

1. **WebSocket Support**: Real-time message delivery to widget
2. **Typing Indicators**: Show when AI is processing
3. **File Uploads**: Support for image/document attachments
4. **Widget Analytics**: Track widget usage and engagement
5. **A/B Testing**: Test different widget configurations
