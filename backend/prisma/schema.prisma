// schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextIndex", "fullTextSearch"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management Models
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  customer  Customer?
  
  @@index([email])
}

enum Role {
  USER
  ADMIN
}

model Customer {
  id             String   @id @default(uuid())
  userId         String   @unique
  companyName    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription   Subscription?
  chatbots       Chatbot[]
  knowledgeBases KnowledgeBase[]
  apiKeys        APIKey[]
  usageLogs      UsageLog[]
  
  @@index([userId])
}

// ============================================
// Billing & Subscription Models
// ============================================

model Plan {
  id                  String   @id @default(uuid())
  name                String
  price               Decimal  @db.Decimal(10, 2)
  currency            Currency @default(USD)
  maxChatbots         Int
  maxMessagesPerMonth Int
  aiProviders         Json     // JSON array de proveedores permitidos
  features            Json     // Características adicionales
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  subscriptions Subscription[]
}

model Subscription {
  id                String             @id @default(uuid())
  customerId        String             @unique
  planId            String
  status            SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  plan     Plan     @relation(fields: [planId], references: [id])
  
  @@index([customerId])
  @@index([planId])
  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

model Invoice {
  id              String        @id @default(uuid())
  invoiceNumber   String        @unique
  customerId      String
  subscriptionId  String?
  amount          Decimal       @db.Decimal(10, 2)
  currency        Currency
  status          InvoiceStatus @default(PENDING)
  paymentMethod   PaymentMethod
  paymentProvider String        // flow, paypal
  transactionId   String?       // ID de transacción de la pasarela
  pdfUrl          String?       @db.Text
  dueDate         DateTime
  paidAt          DateTime?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([customerId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([createdAt])
}

enum Currency {
  USD
  CLP
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  BANK_TRANSFER
  WEBPAY
  KHIPU
}

model PaymentMethodStored {
  id                 String        @id @default(uuid())
  customerId         String
  type               PaymentMethod
  provider           String        // flow, paypal
  providerCustomerId String?       // ID del cliente en la pasarela
  last4              String?       // Últimos 4 dígitos de tarjeta
  brand              String?       // Visa, Mastercard, etc.
  expiryMonth        Int?
  expiryYear         Int?
  isDefault          Boolean       @default(false)
  isActive           Boolean       @default(true)
  metadata           Json?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  
  @@index([customerId])
  @@index([provider])
}

model PaymentTransaction {
  id                    String                   @id @default(uuid())
  customerId            String
  invoiceId             String?
  amount                Decimal                  @db.Decimal(10, 2)
  currency              Currency
  status                PaymentTransactionStatus
  provider              String                   // flow, paypal
  providerTransactionId String?
  paymentMethod         PaymentMethod
  errorMessage          String?                  @db.Text
  metadata              Json?
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  
  @@index([customerId])
  @@index([invoiceId])
  @@index([provider])
  @@index([status])
  @@index([createdAt])
}

enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

model ExchangeRate {
  id           String   @id @default(uuid())
  fromCurrency Currency
  toCurrency   Currency
  rate         Decimal  @db.Decimal(10, 6)
  source       String   // API source (exchangerate-api, etc.)
  validUntil   DateTime
  createdAt    DateTime @default(now())
  
  @@unique([fromCurrency, toCurrency, createdAt])
  @@index([fromCurrency, toCurrency])
  @@index([validUntil])
}

model SubscriptionHistory {
  id             String             @id @default(uuid())
  customerId     String
  subscriptionId String
  planId         String
  action         SubscriptionAction
  previousPlanId String?
  metadata       Json?
  createdAt      DateTime           @default(now())
  
  @@index([customerId])
  @@index([subscriptionId])
  @@index([createdAt])
}

enum SubscriptionAction {
  CREATED
  UPGRADED
  DOWNGRADED
  RENEWED
  CANCELLED
  SUSPENDED
  REACTIVATED
}

model PaymentWebhookLog {
  id           String    @id @default(uuid())
  provider     String    // flow, paypal
  event        String    // payment.completed, subscription.renewed, etc.
  payload      Json      @db.Json
  signature    String?   @db.Text
  isValid      Boolean
  processed    Boolean   @default(false)
  processedAt  DateTime?
  errorMessage String?   @db.Text
  createdAt    DateTime  @default(now())
  
  @@index([provider])
  @@index([processed])
  @@index([createdAt])
}

// ============================================
// Chatbot Models
// ============================================

model Chatbot {
  id              String   @id @default(uuid())
  customerId      String
  name            String
  description     String?  @db.Text
  aiProvider      String   // openai, anthropic, groq, etc.
  aiModel         String   // gpt-4, claude-3-5-sonnet, etc.
  aiConfig        Json     // Configuración específica del modelo
  systemPrompt    String?  @db.Text
  isActive        Boolean  @default(true)
  knowledgeBaseId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  customer              Customer               @relation(fields: [customerId], references: [id], onDelete: Cascade)
  conversations         Conversation[]
  widgetSettings        WidgetSettings?
  knowledgeBase         KnowledgeBase?         @relation(fields: [knowledgeBaseId], references: [id])
  whatsappCloudAccount  WhatsAppCloudAccount?
  whatsappQRSession     WhatsAppQRSession?
  
  @@index([customerId])
  @@index([knowledgeBaseId])
  @@index([isActive])
}

model WidgetSettings {
  id             String   @id @default(uuid())
  chatbotId      String   @unique
  theme          String   @default("light")
  primaryColor   String   @default("#3B82F6")
  position       String   @default("bottom-right")
  welcomeMessage String?  @db.Text
  placeholder    String   @default("Type a message...")
  customCss      String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  chatbot Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  
  @@index([chatbotId])
}

// ============================================
// Conversation & Message Models
// ============================================

model Conversation {
  id             String             @id @default(uuid())
  chatbotId      String
  externalUserId String             // ID del usuario final (puede ser phone, email, etc.)
  channel        Channel            // WIDGET, WHATSAPP_CLOUD, WHATSAPP_QR
  status         ConversationStatus @default(ACTIVE)
  lastMessageAt  DateTime           @default(now())
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  
  chatbot  Chatbot   @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  messages Message[]
  
  @@index([chatbotId])
  @@index([externalUserId])
  @@index([lastMessageAt])
  @@index([channel])
}

enum Channel {
  WIDGET
  WHATSAPP_CLOUD
  WHATSAPP_QR
}

enum ConversationStatus {
  ACTIVE
  CLOSED
  ARCHIVED
  HUMAN_AGENT
}

model Message {
  id             String         @id @default(uuid())
  conversationId String
  content        String         @db.Text
  role           MessageRole
  metadata       Json?          // Información adicional (attachments, etc.)
  deliveryStatus DeliveryStatus @default(PENDING)
  createdAt      DateTime       @default(now())
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([createdAt])
  @@index([role])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ============================================
// Knowledge Base Models
// ============================================

model KnowledgeBase {
  id          String   @id @default(uuid())
  customerId  String
  name        String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  customer Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items    KnowledgeItem[]
  chatbots Chatbot[]
  
  @@index([customerId])
}

model KnowledgeItem {
  id              String   @id @default(uuid())
  knowledgeBaseId String
  title           String
  content         String   @db.Text
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  
  @@index([knowledgeBaseId])
  @@fulltext([title, content])
}

// ============================================
// WhatsApp Integration Models
// ============================================

model WhatsAppCloudAccount {
  id                 String   @id @default(uuid())
  chatbotId          String   @unique
  phoneNumberId      String
  accessToken        String   @db.Text
  webhookVerifyToken String
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  chatbot Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  
  @@index([chatbotId])
  @@index([phoneNumberId])
}

model WhatsAppQRSession {
  id              String          @id @default(uuid())
  chatbotId       String          @unique
  sessionId       String          @unique
  status          QRSessionStatus @default(DISCONNECTED)
  qrCode          String?         @db.Text
  lastConnectedAt DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  chatbot Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  
  @@index([chatbotId])
  @@index([sessionId])
  @@index([status])
}

enum QRSessionStatus {
  DISCONNECTED
  CONNECTING
  QR_READY
  CONNECTED
}

// ============================================
// Webhook & API Models
// ============================================

model WebhookEvent {
  id          String        @id @default(uuid())
  url         String
  event       String        // message.received, conversation.created, etc.
  payload     Json
  status      WebhookStatus @default(PENDING)
  attempts    Int           @default(0)
  lastError   String?       @db.Text
  createdAt   DateTime      @default(now())
  processedAt DateTime?
  
  @@index([status])
  @@index([createdAt])
  @@index([event])
}

enum WebhookStatus {
  PENDING
  SENT
  FAILED
}

model APIKey {
  id          String    @id @default(uuid())
  customerId  String
  key         String    @unique
  name        String
  permissions Json      // Array de permisos
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@index([key])
  @@index([isActive])
}

// ============================================
// AI Provider Models
// ============================================

model AIProviderConfig {
  id        String   @id @default(uuid())
  provider  String   // openai, anthropic, etc.
  apiKey    String   @db.Text
  baseUrl   String?
  config    Json?    // Configuración adicional
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([provider])
  @@index([isActive])
}

// ============================================
// Usage & Billing Models
// ============================================

model UsageLog {
  id         String    @id @default(uuid())
  customerId String
  type       UsageType
  quantity   Int
  metadata   Json?
  createdAt  DateTime  @default(now())
  
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@index([createdAt])
  @@index([type])
}

enum UsageType {
  MESSAGE
  AI_REQUEST
  WHATSAPP_MESSAGE
}

model BillingEvent {
  id          String        @id @default(uuid())
  customerId  String
  amount      Decimal       @db.Decimal(10, 2)
  description String
  status      BillingStatus @default(PENDING)
  metadata    Json?
  createdAt   DateTime      @default(now())
  
  @@index([customerId])
  @@index([createdAt])
  @@index([status])
}

enum BillingStatus {
  PENDING
  COMPLETED
  FAILED
}
